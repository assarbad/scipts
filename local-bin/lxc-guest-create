#!/usr/bin/env bash
# vim: set autoindent smartindent tabstop=4 shiftwidth=4 noexpandtab filetype=sh:
pushd $(dirname $0) > /dev/null; CURRABSPATH=$(readlink -nf "$(pwd)"); popd > /dev/null; # Get the directory in which the script resides
BACKING=dir
LXCBASE="$(lxc-config lxc.lxcpath)"
LXCNAME="${1}"
[[ -n "$LXCNAME" ]] || { echo -e "ERROR: you must give a name for the guest container.\n\nSYNTAX:\n\t${0##*/} <name>"; exit 1; }
export MIRROR=$(awk "\$1 ~ /^deb\$/ && \$4 ~ /main/ && \$3 ~ /^$(lsb_release -sc)\$/ {print \$2; exit}" /etc/apt/sources.list)
export SECURITY_MIRROR=$(awk "\$1 ~ /^deb\$/ && \$4 ~ /main/ && \$3 ~ /^$(lsb_release -sc)-security\$/ {print \$2; exit}" /etc/apt/sources.list)
export HTTP_PROXY="http://localhost:3142"
export packages_template="bash-completion,sudo,tmux,unzip,openssh-server,unattended-upgrades,cron"
TMPLXCTPL=$(mktemp)
echo "$MIRROR - $SECURITY_MIRROR"
cat /usr/share/lxc/templates/lxc-ubuntu \
	| sed '/^finalize_user/,/^\}/d;/finalize_user /,/finalize_user /d;/^echo ""/,$d' \
	| sed '/^user=/s/ubuntu/oliver/;/^password=/s/ubuntu/password/' \
	| sed '/debootstrap/ { s/ --verbose/ --variant=minbase --exclude=crda,laptop-detect,tasksel,tasksel-data/ }' \
	> "$TMPLXCTPL"
cat <<'EOF' >> "$TMPLXCTPL"
cat <<'EODATA' >> $rootfs/root/in-guest-job
#!/usr/bin/env bash
FAKE_SERVICES="/root/fake-service"
ORIG_PATH="$PATH"
FAKE_PATH="$FAKE_SERVICES:$ORIG_PATH"
mkdir -p "$FAKE_SERVICES"
for i in initctl invoke-rc.d restart start stop start-stop-daemon service; do (echo '#!/bin/sh';echo echo $i '"$@"';echo "/bin/true") > "$FAKE_SERVICES/$i"; chmod a+x "$FAKE_SERVICES/$i"; done
echo "en_US.UTF-8 UTF-8"|tee /var/lib/locales/supported.d/local
rm -f /var/lib/locales/supported.d/en
echo 'LANG="en_US.UTF-8"'|tee "/etc/default/locale"
export DEBIAN_FRONTEND=noninteractive
apt-get -y -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" update
apt-get -y -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" dist-upgrade
PATH="$FAKE_PATH" apt-get -y -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" --no-install-recommends install libui-dialog-perl dialog
apt-get -y update
apt-get -y -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" dist-upgrade
PATH="$FAKE_PATH" apt-get -y -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" --purge autoremove language-pack-en-base language-pack-en console-setup debconf-i18n dmsetup eject kbd keyboard-configuration lockfile-progs ubuntu-minimal
PATH="$FAKE_PATH" apt-get -y -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" --no-install-recommends install acl bash-completion bzr colordiff cron-apt debsums dnsutils file git git-svn heirloom-mailx htop iputils-ping isc-dhcp-client lsof make manpages man-db mc mercurial molly-guard mlocate psmisc pv python-mako python-mechanize sharutils ssh software-properties-common sudo tmux tree unattended-upgrades unbound-host unzip vim-nox wget whois xz-utils zip zsh-doc zsh-static
dpkg-reconfigure -f noninteractive locales
apt-add-repository -y ppa:nginx/stable
adduser oliver sudo
sed -i '/ssh_host_ecdsa_key/d;/^#PasswordAuthentication/ {s/#//;s/ yes/ no/}' "/etc/ssh/sshd_config"
rm -f /etc/ssh/ssh_host_*
ssh-keygen -t rsa -b 4096 -C "root@$(cat /etc/hostname)" -N '' -o -f /etc/ssh/ssh_host_rsa_key
ssh-keygen -t dsa         -C "root@$(cat /etc/hostname)" -N '' -o -f /etc/ssh/ssh_host_dsa_key
ssh-keygen -t ed25519     -C "root@$(cat /etc/hostname)" -N '' -o -f /etc/ssh/ssh_host_ed25519_key
for i in /etc/ssh/ssh_host_ecdsa_key /etc/ssh/ssh_host_key; do
	touch $i $i.pub && chmod ugo=,ug+r $i $i.pub && chattr +i $i $i.pub
done
chmod -R o= /root
cp /usr/share/doc/tmux/examples/bash_completion_tmux.sh /etc/bash_completion.d/
sed -i '/^%sudo/s/ALL$/NOPASSWD:ALL/' "/etc/sudoers"
rm -f "/home/oliver/.bashrc" "/root/.bashrc"
hg --cwd "/home/oliver" clone https://bitbucket.org/assarbad/dotfiles .dotfiles
hg --cwd "/root" clone https://bitbucket.org/assarbad/dotfiles .dotfiles
make -C "/home/oliver/.dotfiles" "TGTDIR=/home/oliver" install
make -C "/root/.dotfiles" "TGTDIR=/root" install
PATH="$FAKE_PATH" apt-get -y --purge autoremove
PATH="$FAKE_PATH" apt-get -y --purge autoremove
chown -R "oliver:" "/home/oliver"
apt-get -y autoclean
apt-get -y clean
updatedb
apt-file update
PATH="$FAKE_PATH" apt-get -y -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" --no-install-recommends install etckeeper
mv "/etc/apt/apt.conf.d/70proxy" "/etc/apt/apt.conf.d/00proxy"
echo 'Acquire::ForceIPv4 { true; };' | tee "/etc/apt/apt.conf.d/00inet-v4"
echo "Acquire::http::Proxy \"http://yggdrasil.lan:3142\" ;"|tee "/etc/apt/apt.conf.d/00proxy"
unset DEBIAN_FRONTEND
EODATA
chmod +x "$rootfs/root/in-guest-job"
chroot $rootfs "/root/in-guest-job"
echo -n "" > $rootfs/etc/legal
EOF
chmod +x "$TMPLXCTPL"
lxc-create -t "$TMPLXCTPL" -n $LXCNAME -P "$LXCBASE" -B $BACKING -- -dF|grep -v "^#"
echo -n "${LXCNAME}.lan"|tee "$LXCBASE/$LXCNAME/rootfs/etc/hostname"
